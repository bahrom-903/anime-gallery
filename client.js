// --- –ù–ê–ß–ê–õ–û –§–ê–ô–õ–ê client.js (–ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô) ---

// client.js - v10 (DIAMOND PATCH 2.0)
document.addEventListener('DOMContentLoaded', () => {
    // –ö–æ–¥ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∏ –∫–æ–Ω—Å—Ç–∞–Ω—Ç
    const elements = { selectAllBtn: document.getElementById('select-all-btn'), deselectAllBtn: document.getElementById('deselect-all-btn'), generateBtn: document.getElementById('generate-btn'), findSimilarBtn: document.getElementById('find-similar-btn'), randomImageBtn: document.getElementById('random-image-btn'), promptInput: document.getElementById('prompt-input'), loader: document.getElementById('loader'), loaderText: document.getElementById('loader-text'), imageContainer: document.getElementById('result-image-container'), errorMessage: document.getElementById('error-message'), saveBtn: document.getElementById('save-btn'), previewBtn: document.getElementById('preview-btn'), galleryContainer: document.getElementById('gallery'), uploadBtn: document.getElementById('upload-btn'), uploadInput: document.getElementById('upload-input'), exportBtn: document.getElementById('export-selected-btn'), deleteBtn: document.getElementById('delete-selected-btn'), menuBtn: document.getElementById('menu-btn'), dropdownMenu: document.getElementById('dropdownMenu'), settingsPanel: document.getElementById('settingsPanel'), settingsOpenBtn: document.getElementById('settings-open-btn'), themePanel: document.getElementById('themePanel'), themePanelOpenBtn: document.getElementById('theme-panel-open-btn'), themeResetBtn: document.getElementById('theme-reset-btn'), sortPanel: document.getElementById('sortPanel'), sortPanelOpenBtn: document.getElementById('sort-panel-open-btn'), sortGrid: document.getElementById('sortGrid'), imageViewer: document.getElementById('image-viewer'), viewerImg: document.getElementById('viewer-img'), themeGrid: document.getElementById('themeGrid'), clearGalleryBtn: document.getElementById('gallery-clear-btn'), setBgFromGalleryBtn: document.getElementById('set-bg-from-gallery-btn'), backgroundPanel: document.getElementById('backgroundPanel'), backgroundPanelOpenBtn: document.getElementById('background-panel-open-btn'), backgroundResetBtn: document.getElementById('background-reset-btn'), backgroundGrid: document.getElementById('backgroundGrid'), backgroundUploadBtn: document.getElementById('background-upload-btn'), backgroundUploadInput: document.getElementById('background-upload-input'), randomPromptBtn: document.getElementById('random-prompt-btn'), negativePromptInput: document.getElementById('negative-prompt-input'), styleSelector: document.getElementById('style-selector'), changelogOpenBtn: document.getElementById('changelog-open-btn'), bugReportOpenBtn: document.getElementById('bug-report-open-btn'), suggestionOpenBtn: document.getElementById('suggestion-open-btn'), changelogPanel: document.getElementById('changelogPanel'), bugReportPanel: document.getElementById('bugReportPanel'), suggestionPanel: document.getElementById('suggestionPanel'), bugReportText: document.getElementById('bug-report-text'), suggestionText: document.getElementById('suggestion-text'), submitBugReportBtn: document.getElementById('submit-bug-report-btn'), submitSuggestionBtn: document.getElementById('submit-suggestion-btn'), bugReportStatus: document.getElementById('bug-report-status'), suggestionStatus: document.getElementById('suggestion-status'), contextMenu: document.getElementById('context-menu'), categoryControls: document.getElementById('category-controls'), langSwitcherBtn: document.getElementById('lang-switcher-btn'), };
    const DB_NAME = 'AnimeGalleryDB_V18_Diamond', DB_VERSION = 1, STORE_SETTINGS = 'settings', STORE_GALLERY = 'gallery', STORE_BACKGROUNDS = 'defaultBackgrounds';
    let state = { currentSort: 'date_desc', isFavFilterActive: false, currentCategory: 'waifu', currentLanguage: 'ru', contextedItemId: null, };
    const categories = { 'waifu': { keywords: 'anime, waifu, girl', sources: { random: 'https://api.waifu.pics/sfw/waifu', search: 'https://api.waifu.pics/sfw/waifu' } }, 'anime_gif': { keywords: 'anime, gif, animation', sources: { random: 'https://api.waifu.pics/sfw/dance', search: 'https://api.waifu.pics/sfw/happy' } }, 'cyberpunk': { keywords: 'cyberpunk, neon, futuristic, city', sources: { random: 'https://source.unsplash.com/1600x900/?cyberpunk', search: 'https://source.unsplash.com/1600x900/?cyberpunk,neon' } }, 'nature': { keywords: 'nature, landscape, mountains, forest', sources: { random: 'https://source.unsplash.com/1600x900/?nature', search: 'https://source.unsplash.com/1600x900/?landscape,nature' } }, 'games': { keywords: 'video game, fan art, gaming', sources: { random: 'https://source.unsplash.com/1600x900/?gaming,character', search: 'https://source.unsplash.com/1600x900/?video,game,art' } }, 'dark_anime': { keywords: 'dark fantasy, gothic, monster, horror art', sources: { random: 'https://source.unsplash.com/1600x900/?dark,fantasy,art', search: 'https://source.unsplash.com/1600x900/?gothic,art' } }, 'supercars': { keywords: 'supercar, sportscar, luxury car', sources: { random: 'https://source.unsplash.com/1600x900/?supercar', search: 'https://source.unsplash.com/1600x900/?sportscar' } }, };
    const themes = [ { id: "dark" }, { id: "light" }, { id: "gray" }, { id: "retro" }, { id: "dracula" }, { id: "nord" }, { id: "solarized" }, { id: "gruvbox" }, { id: "monokai" }, { id: "tomorrow_night" }, { id: "one_dark" }, { id: "cyberpunk" }, { id: "matrix" }, { id: "crimson" }, { id: "synthwave" } ];
    const styles = { 'no_style': '', 'anime': ', anime style, waifu', 'photorealistic': ', photorealistic, 4k, ultra detailed', 'fantasy': ', fantasy art, intricate details, epic scene', 'cyberpunk_style': ', cyberpunk style, neon lights', 'digital_painting': ', digital painting, concept art', 'low_poly': ', low poly, isometric' };
    const defaultBackgroundSources = [ { name: 'cyberpunk', url: './backgrounds/cyberpunk.jpg'}, { name: 'night-tokyo', url: './backgrounds/night-tokyo.jpg'}, { name: 'canyon', url: './backgrounds/canyon.jpg'}, { name: 'mountain-river', url: './backgrounds/mountain-river.jpg'}, { name: 'dark-fantasy', url: './backgrounds/dark-fantasy.jpg'}, { name: 'noir-landscape', url: './backgrounds/noir-landscape.jpg'}, { name: 'auto-night', url: './backgrounds/auto-night.jpg'}, { name: 'anime-city', url: './backgrounds/anime-city.jpg'}, { name: 'nier-2b', url: './backgrounds/nier-2b.jpg'}, { name: 'genos', url: './backgrounds/genos.png'} ];
    const openDb = () => new Promise((resolve, reject) => { const request = indexedDB.open(DB_NAME, DB_VERSION); request.onerror = () => reject("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å IndexedDB."); request.onupgradeneeded = e => { const db = e.target.result; if (!db.objectStoreNames.contains(STORE_SETTINGS)) db.createObjectStore(STORE_SETTINGS); if (!db.objectStoreNames.contains(STORE_GALLERY)) { const galleryStore = db.createObjectStore(STORE_GALLERY, { keyPath: 'id' }); galleryStore.createIndex('category', 'category', { unique: false }); } if (!db.objectStoreNames.contains(STORE_BACKGROUNDS)) db.createObjectStore(STORE_BACKGROUNDS, { keyPath: 'id' }); }; request.onsuccess = e => resolve(e.target.result); });
    const dbRequest = (storeName, type, ...args) => new Promise(async (resolve, reject) => { try { const db = await openDb(); const tx = db.transaction(storeName, type.startsWith('get') ? 'readonly' : 'readwrite'); const store = tx.objectStore(storeName); const req = store[type](...args); req.onsuccess = () => resolve(req.result); req.onerror = () => reject(`–û—à–∏–±–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (${storeName}): ${req.error}`); } catch (e) { reject(e) } });
    const translations = { en: { settings: 'Settings', language: 'Language', new_generation: 'New Generation', generate_ai: '‚ú® Generate AI', find_online: 'üåé Find Online', random_image: 'üé≤ Random', save: 'üíæ Save', preview: 'üîç Preview', gallery: 'üìÅ Gallery', upload_yours: 'üì• Upload Yours', export: 'üì§ Export', set_as_bg: 'üèûÔ∏è Set as Background', delete: 'üóë Delete', select_all: '‚úÖ Select All', deselect_all: 'üî≤ Deselect All', choose_theme: 'üé® Choose Theme', background: 'üñºÔ∏è Background', sorting: 'üîÄ Sorting', changelog: 'üèÜ Hall of Fame & Versions', report_bug: 'üêû Report a Bug', suggest_idea: 'üí° Suggest an Idea', clear_gallery: 'üóëÔ∏è Clear Gallery', themes: 'üé® Themes', backgrounds: 'üñºÔ∏è Backgrounds', upload_your_bg: 'üì§ Upload your background', sort_newest: 'Newest first', sort_oldest: 'Oldest first', sort_random: 'Random', sort_favorites: '‚úÖ Favorites only', cat_waifu: 'Waifu', cat_anime_gif: 'Anime Gifs', cat_cyberpunk: 'Cyberpunk', cat_nature: 'Nature', cat_games: 'Games', cat_dark_anime: 'Dark Anime', cat_supercars: 'Supercars', style_no_style: '-- No Style --', style_anime: 'Anime / Waifu', style_photorealistic: 'Photorealistic', style_fantasy: 'Fantasy Art', style_cyberpunk_style: 'Cyberpunk', style_digital_painting: 'Digital Painting', style_low_poly: '3D (Low Poly)', ctx_rename: 'Rename', ctx_copy_prompt: 'Copy Prompt', prompt_placeholder: "Describe your idea here... (e.g., 'girl with red hair')", negative_prompt_placeholder: "‚ùå Negative prompt (what NOT to draw)", bug_report_desc: "Please describe the problem in as much detail as possible. What were you doing when it occurred?", bug_report_placeholder: "For example: When I click 'Export', nothing happens...", suggestion_desc: "Have an idea how to make the service better? Tell us!", suggestion_placeholder: "For example: It would be cool to add the ability to change the image size...", send: "Send" }, ru: { settings: '–ù–∞—Å—Ç—Ä–æ–π–∫–∏', language: '–Ø–∑—ã–∫', new_generation: '–ù–æ–≤–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è', generate_ai: '‚ú® –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å AI', find_online: 'üåé –ù–∞–π—Ç–∏ –≤ —Å–µ—Ç–∏', random_image: 'üé≤ –°–ª—É—á–∞–π–Ω–æ–µ', save: 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å', preview: 'üîç –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä', gallery: 'üìÅ –ì–∞–ª–µ—Ä–µ—è', upload_yours: 'üì• –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–≤–æ—ë', export: 'üì§ –≠–∫—Å–ø–æ—Ä—Ç', set_as_bg: 'üèûÔ∏è –°–¥–µ–ª–∞—Ç—å —Ñ–æ–Ω–æ–º', delete: 'üóë –£–¥–∞–ª–∏—Ç—å', select_all: '‚úÖ –í—ã–±—Ä–∞—Ç—å –≤—Å—ë', deselect_all: 'üî≤ –û—Ç–º–µ–Ω–∏—Ç—å –≤—Å—ë', choose_theme: 'üé® –í—ã–±—Ä–∞—Ç—å —Ç–µ–º—É', background: 'üñºÔ∏è –§–æ–Ω', sorting: 'üîÄ –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞', changelog: 'üèÜ –ó–∞–ª –°–ª–∞–≤—ã –∏ –í–µ—Ä—Å–∏–∏', report_bug: 'üêû –°–æ–æ–±—â–∏—Ç—å –æ –ø—Ä–æ–±–ª–µ–º–µ', suggest_idea: 'üí° –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –∏–¥–µ—é', clear_gallery: 'üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –≥–∞–ª–µ—Ä–µ—é', themes: 'üé® –¢–µ–º—ã', backgrounds: 'üñºÔ∏è –§–æ–Ω—ã', upload_your_bg: 'üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–≤–æ–π —Ñ–æ–Ω', sort_newest: '–°–Ω–∞—á–∞–ª–∞ –Ω–æ–≤—ã–µ', sort_oldest: '–°–Ω–∞—á–∞–ª–∞ —Å—Ç–∞—Ä—ã–µ', sort_random: '–°–ª—É—á–∞–π–Ω–æ', sort_favorites: '‚úÖ –¢–æ–ª—å–∫–æ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ', cat_waifu: '–í–∞–π—Ñ—É', cat_anime_gif: '–ê–Ω–∏–º–µ –ì–∏—Ñ–∫–∏', cat_cyberpunk: '–ö–∏–±–µ—Ä–ø–∞–Ω–∫', cat_nature: '–ü—Ä–∏—Ä–æ–¥–∞', cat_games: '–ò–≥—Ä—ã', cat_dark_anime: 'Dark Anime', cat_supercars: '–°—É–ø–µ—Ä–∫–∞—Ä—ã', style_no_style: '-- –ë–µ–∑ —Å—Ç–∏–ª—è --', style_anime: '–ê–Ω–∏–º–µ / –í–∞–π—Ñ—É', style_photorealistic: '–§–æ—Ç–æ—Ä–µ–∞–ª–∏–∑–º', style_fantasy: '–§—ç–Ω—Ç–µ–∑–∏ –ê—Ä—Ç', style_cyberpunk_style: '–ö–∏–±–µ—Ä–ø–∞–Ω–∫', style_digital_painting: '–¶–∏—Ñ—Ä–æ–≤–æ–π —Ä–∏—Å—É–Ω–æ–∫', style_low_poly: '3D (Low Poly)', ctx_rename: '–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å', ctx_copy_prompt: '–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–º–ø—Ç', prompt_placeholder: "–û–ø–∏—à–∏ —Å–≤–æ—é –∏–¥–µ—é –∑–¥–µ—Å—å... (–Ω–∞–ø—Ä–∏–º–µ—Ä, '–¥–µ–≤—É—à–∫–∞ —Å –∫—Ä–∞—Å–Ω—ã–º–∏ –≤–æ–ª–æ—Å–∞–º–∏')", negative_prompt_placeholder: "‚ùå –ù–µ–≥–∞—Ç–∏–≤–Ω—ã–π –ø—Ä–æ–º–ø—Ç (—á—Ç–æ –ù–ï –Ω—É–∂–Ω–æ —Ä–∏—Å–æ–≤–∞—Ç—å)", bug_report_desc: "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–ø–∏—à–∏—Ç–µ –ø—Ä–æ–±–ª–µ–º—É –∫–∞–∫ –º–æ–∂–Ω–æ –ø–æ–¥—Ä–æ–±–Ω–µ–µ. –ß—Ç–æ –≤—ã –¥–µ–ª–∞–ª–∏, –∫–æ–≥–¥–∞ –æ–Ω–∞ –≤–æ–∑–Ω–∏–∫–ª–∞?", bug_report_placeholder: "–ù–∞–ø—Ä–∏–º–µ—Ä: –ö–æ–≥–¥–∞ —è –Ω–∞–∂–∏–º–∞—é '–≠–∫—Å–ø–æ—Ä—Ç', –Ω–∏—á–µ–≥–æ –Ω–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç...", suggestion_desc: "–ï—Å—Ç—å –∏–¥–µ—è, –∫–∞–∫ —Å–¥–µ–ª–∞—Ç—å —Å–µ—Ä–≤–∏—Å –ª—É—á—à–µ? –†–∞—Å—Å–∫–∞–∂–∏—Ç–µ!", suggestion_placeholder: "–ù–∞–ø—Ä–∏–º–µ—Ä: –ë—ã–ª–æ –±—ã –∫—Ä—É—Ç–æ –¥–æ–±–∞–≤–∏—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –º–µ–Ω—è—Ç—å —Ä–∞–∑–º–µ—Ä –∫–∞—Ä—Ç–∏–Ω–∫–∏...", send: "–û—Ç–ø—Ä–∞–≤–∏—Ç—å" } };
    const setLanguage = (lang) => { state.currentLanguage = lang; localStorage.setItem('language', lang); const langPack = translations[lang] || translations.ru; document.querySelectorAll('[data-lang-key]').forEach(el => { const key = el.dataset.langKey; if (langPack[key]) el.textContent = langPack[key]; }); document.querySelectorAll('[data-lang-placeholder-key]').forEach(el => { const key = el.dataset.langPlaceholderKey; if (langPack[key]) el.placeholder = langPack[key]; }); renderCategories(); renderThemes(); renderStyles(); renderSortOptions(); };
    const renderGallery = async () => { try { let allGalleryData = await dbRequest(STORE_GALLERY, 'getAll'); elements.galleryContainer.innerHTML = ""; let categoryData = allGalleryData.filter(item => item.category === state.currentCategory); let dataToRender = state.isFavFilterActive ? categoryData.filter(e => e.favorite) : [...categoryData]; if (state.currentSort === 'date_asc') dataToRender.sort((a, b) => a.id - b.id); else if (state.currentSort === 'date_desc') dataToRender.sort((a, b) => b.id - a.id); else if (state.currentSort === 'random') { for (let i = dataToRender.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [dataToRender[i], dataToRender[j]] = [dataToRender[j], dataToRender[i]]; } } dataToRender.forEach(entry => { const item = document.createElement('div'); item.className = "gallery-item"; item.dataset.id = entry.id; const img = document.createElement('img'); img.src = entry.data; img.loading = "lazy"; img.alt = entry.prompt; img.addEventListener('dblclick', () => viewImage(entry.data)); const controls = document.createElement('div'); controls.className = 'item-controls'; const cb = document.createElement('input'); cb.type = 'checkbox'; cb.className = 'select-checkbox'; const fav = document.createElement('div'); fav.innerText = entry.favorite ? '‚≠ê' : '‚òÜ'; fav.className = 'favorite-star'; fav.addEventListener('click', (e) => {e.stopPropagation(); toggleFavorite(entry.id, !entry.favorite)}); const menuBtn = document.createElement('button'); menuBtn.className = 'item-menu-btn'; menuBtn.innerHTML = '‚ãÆ'; menuBtn.addEventListener('click', (e) => { e.stopPropagation(); showContextMenu(e.target, entry.id); }); controls.append(cb, fav, menuBtn); item.append(img, controls); elements.galleryContainer.appendChild(item); }); } catch (e) { showError(`–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –≥–∞–ª–µ—Ä–µ—é: ${e.message}`); }};
    const renderCategories = () => { elements.categoryControls.innerHTML = ''; const langPack = translations[state.currentLanguage] || translations.ru; for (const id of Object.keys(categories)) { const btn = document.createElement('button'); btn.dataset.categoryId = id; btn.textContent = langPack[`cat_${id}`] || id.replace(/_/g, ' '); if (id === state.currentCategory) btn.classList.add('active-category'); btn.addEventListener('click', () => handleCategoryClick(id)); elements.categoryControls.appendChild(btn); } };
    const renderThemes = () => { elements.themeGrid.innerHTML = ''; themes.forEach(t => { const c = document.createElement("div"); c.className = "preview-card"; c.dataset.theme = t.id; const themeName = t.id.charAt(0).toUpperCase() + t.id.slice(1).replace(/_/g, ' '); c.innerHTML = `<div class="preview-box theme-${t.id}"></div><div class="preview-name">${themeName}</div>`; elements.themeGrid.appendChild(c); }); };
    const renderStyles = () => { elements.styleSelector.innerHTML = ''; const langPack = translations[state.currentLanguage] || translations.ru; for (const [id, value] of Object.entries(styles)) { const option = document.createElement('option'); option.value = value; option.textContent = langPack[`style_${id}`] || id; elements.styleSelector.appendChild(option); } };
    const renderSortOptions = () => { const langPack = translations[state.currentLanguage] || translations.ru; const o = { 'date_desc': langPack.sort_newest, 'date_asc': langPack.sort_oldest, 'random': langPack.sort_random, 'separator': '---', 'filter_favorite': langPack.sort_favorites }; elements.sortGrid.innerHTML = ''; for (const [k, v] of Object.entries(o)) { if (k === 'separator') { elements.sortGrid.appendChild(document.createElement('hr')); continue; } const b = document.createElement('button'); b.className = 'panel-button'; b.dataset.sort = k; b.textContent = v; if (k === 'filter_favorite' && state.isFavFilterActive) b.classList.add('active-filter'); elements.sortGrid.appendChild(b); } };
    const renderBackgrounds = async () => { try { const storedBgs = await dbRequest(STORE_BACKGROUNDS, 'getAll'); elements.backgroundGrid.innerHTML = ''; document.querySelectorAll('#backgroundGrid [data-object-url]').forEach(el => URL.revokeObjectURL(el.dataset.objectUrl)); storedBgs.forEach(bg => { const objectURL = URL.createObjectURL(bg.blob); const c = document.createElement("div"); c.className = "preview-card"; c.dataset.bgId = bg.id; c.innerHTML = `<div class="preview-box" style="background-image: url(${objectURL});" data-object-url="${objectURL}"></div><div class="preview-name">${bg.id}</div>`; elements.backgroundGrid.appendChild(c); }); } catch(e) { console.error("–û—à–∏–±–∫–∞ —Ä–µ–Ω–¥–µ—Ä–∞ —Ñ–æ–Ω–æ–≤:", e); } };
    const showContextMenu = (buttonElement, itemId) => { hideContextMenu(); state.contextedItemId = itemId; const langPack = translations[state.currentLanguage] || translations.ru; const rect = buttonElement.getBoundingClientRect(); const menu = elements.contextMenu; menu.style.display = 'block'; menu.style.left = `${rect.left + window.scrollX}px`; menu.style.top = `${rect.bottom + window.scrollY + 5}px`; menu.innerHTML = `<button data-action="rename">${langPack.ctx_rename}</button><button data-action="copy-prompt">${langPack.ctx_copy_prompt}</button>`; };
    const hideContextMenu = () => { if(elements.contextMenu) elements.contextMenu.style.display = 'none'; };
    const setUIGeneratorState = (isLoading, message = '') => { const btns = [elements.generateBtn, elements.findSimilarBtn, elements.randomImageBtn, elements.randomPromptBtn]; btns.forEach(btn => { if(btn) btn.disabled = isLoading; }); elements.loader.classList.toggle('hidden', !isLoading); if (isLoading) { elements.loaderText.textContent = message; elements.imageContainer.innerHTML = ''; elements.errorMessage.classList.add('hidden'); elements.saveBtn.classList.add('hidden'); elements.previewBtn.classList.add('hidden'); } };
    const displayGeneratedImage = (imageUrl, prompt) => new Promise((resolve, reject) => { const img = new Image(); img.crossOrigin = "Anonymous"; img.src = imageUrl; img.alt = prompt; img.onload = () => { elements.imageContainer.innerHTML = ''; elements.imageContainer.appendChild(img); elements.saveBtn.classList.remove('hidden'); elements.previewBtn.classList.remove('hidden'); resolve(); }; img.onerror = () => reject(new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ.")); });
    const showError = (message) => { elements.errorMessage.textContent = message; elements.errorMessage.classList.remove('hidden'); };
    const openPanel = (p) => { if(p) p.style.display = 'flex'; };
    const closePanel = (p) => { if(p) p.style.display = 'none'; };
    const viewImage = (src) => { if (elements.viewerImg && elements.imageViewer) { elements.viewerImg.src = src; openPanel(elements.imageViewer); }};
    const handleServerRequest = async (endpoint, body, loadingMessage, successMessage, promptText) => { setUIGeneratorState(true, loadingMessage); try { const response = await fetch(endpoint, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) }); if (!response.ok) { let errorText = '–û—à–∏–±–∫–∞ –æ—Ç–≤–µ—Ç–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞'; try { const errorData = await response.json(); errorText = errorData.error || errorText; } catch(e){} throw new Error(errorText); } const result = await response.json(); setUIGeneratorState(true, successMessage); await displayGeneratedImage(result.imageUrl, promptText); } catch (e) { showError(`–û—à–∏–±–∫–∞: ${e.message}`); console.error(`–û—à–∏–±–∫–∞ –≤ ${endpoint}:`, e); } finally { setUIGeneratorState(false); } };
    const handleAiGeneration = async () => { const userPrompt = elements.promptInput.value.trim(); const stylePrompt = elements.styleSelector.value; const category = categories[state.currentCategory]; if (!userPrompt) { return showError('–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ.'); } const promptParts = [userPrompt, category.keywords, stylePrompt]; const finalPrompt = promptParts.filter(p => p && p.trim() !== '').join(', '); const negativePrompt = elements.negativePromptInput.value.trim(); await handleServerRequest('/generate-image', { prompt: finalPrompt, negative_prompt: negativePrompt }, '–û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä...', 'AI-–≥–µ–Ω–µ—Ä–∞—Ü–∏—è...', userPrompt); };
    const findSimilarOnline = async () => { const category = categories[state.currentCategory]; await handleServerRequest('/get-image-from-source', { url: category.sources.search }, '–ü–æ–∏—Å–∫ –≤ —Å–µ—Ç–∏...', '–ó–∞–≥—Ä—É–∑–∫–∞...', `–ü–æ–∏—Å–∫: ${category.keywords}`); };
    const getRandomImage = async () => { const category = categories[state.currentCategory]; await handleServerRequest('/get-image-from-source', { url: category.sources.random }, '–ò—â–µ–º —Å–ª—É—á–∞–π–Ω–æ–µ...', '–ó–∞–≥—Ä—É–∑–∫–∞...', `–°–ª—É—á–∞–π–Ω–æ–µ: ${category.keywords}`); };
    const addEntryToGallery = async (dataUrl, prompt) => { const newEntry = { id: Date.now(), prompt: prompt || `image_${Date.now()}`, data: dataUrl, favorite: false, date: new Date().toISOString(), category: state.currentCategory }; try { await dbRequest(STORE_GALLERY, 'put', newEntry); await renderGallery(); alert("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!"); } catch(e) { console.error(e); showError(`–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö: ${e.message}`); } };
    const handleCategoryClick = (categoryId) => { state.currentCategory = categoryId; localStorage.setItem('currentCategory', categoryId); renderCategories(); renderGallery(); };
    const applyTheme = (id) => { document.body.className = id ? `theme-${id}` : ''; document.body.classList.toggle('has-custom-bg', !!document.body.style.getPropertyValue('--bg-image-url')); localStorage.setItem("theme", id); };
    const saveResultToGallery = async () => { const img = elements.imageContainer.querySelector('img'); if (!img || !img.src) return; setUIGeneratorState(true, '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...'); try { const r = await fetch(img.src, {credentials: 'omit'}); if (!r.ok) throw new Error("–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è"); const blob = await r.blob(); const dataUrl = await new Promise((resolve, reject) => { const reader = new FileReader(); reader.onloadend = () => resolve(reader.result); reader.onerror = reject; reader.readAsDataURL(blob); }); await addEntryToGallery(dataUrl, img.alt); } catch (e) { console.error(e); showError("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: " + e.message); } finally { setUIGeneratorState(false); } };
    const toggleFavorite = async (id, isFavorite) => { try { const entry = await dbRequest(STORE_GALLERY, 'get', id); if(entry) { entry.favorite = isFavorite; await dbRequest(STORE_GALLERY, 'put', entry); await renderGallery(); } } catch (e) { console.error(e); }};
    const deleteSelected = async () => { const selectedItems = document.querySelectorAll('.gallery-item .select-checkbox:checked'); if (selectedItems.length === 0) { alert("–ù–∏—á–µ–≥–æ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ."); return; } if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å ${selectedItems.length} —ç–ª–µ–º–µ–Ω—Ç(–æ–≤)?`)) return; for (const cb of selectedItems) { await dbRequest(STORE_GALLERY, 'delete', parseInt(cb.closest('.gallery-item').dataset.id)); } await renderGallery(); };
    const exportSelected = async () => { const selectedItems = document.querySelectorAll('.gallery-item .select-checkbox:checked'); if (selectedItems.length === 0) { alert("–ù–∏—á–µ–≥–æ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ"); return; } const zip = new JSZip(); for (const cb of selectedItems) { const item = await dbRequest(STORE_GALLERY, 'get', parseInt(cb.closest('.gallery-item').dataset.id)); if (item && item.data) { const fileName = (item.prompt ? item.prompt.replace(/[\\/:*?"<>|]/g, '').substring(0, 50) : `image_${item.id}`) || `image_${item.id}`; zip.file(`${fileName}.png`, item.data.split(',')[1], { base64: true }); } } zip.generateAsync({ type: "blob" }).then(content => { const a = document.createElement('a'); a.href = URL.createObjectURL(content); a.download = `anime_gallery_${Date.now()}.zip`; a.click(); URL.revokeObjectURL(a.href); }); };
    const clearGallery = async () => { if (confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ù–ê–í–°–ï–ì–î–ê —É–¥–∞–ª–∏—Ç—å –í–°–ï –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∑ –≥–∞–ª–µ—Ä–µ–∏?")) { await dbRequest(STORE_GALLERY, 'clear'); await renderGallery(); } };
    const handleUpload = (e) => { const f = e.target.files[0]; if (!f) return; if(confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å —ç—Ç–æ—Ç —Ñ–∞–π–ª –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏—é "${(translations[state.currentLanguage] || translations.ru)[`cat_${state.currentCategory}`]}"?`)) { const r = new FileReader(); r.onload = async (ev) => { setUIGeneratorState(true, '–ó–∞–≥—Ä—É–∑–∫–∞...'); try { await addEntryToGallery(ev.target.result, f.name); } catch(err) { showError(err.message); } finally { setUIGeneratorState(false); } }; r.readAsDataURL(f); } e.target.value = ''; };
    const generateRandomPrompt = () => { const promptParts = { subject: ["–ø–æ—Ä—Ç—Ä–µ—Ç –¥–µ–≤—É—à–∫–∏", "—Ä—ã—Ü–∞—Ä—å –≤ –¥–æ—Å–ø–µ—Ö–∞—Ö", "–æ–¥–∏–Ω–æ–∫–æ–µ –¥–µ—Ä–µ–≤–æ", "—Ñ—ç–Ω—Ç–µ–∑–∏ –≥–æ—Ä–æ–¥", "–∫–æ—Å–º–∏—á–µ—Å–∫–∏–π –∫–æ—Ä–∞–±–ª—å", "–¥—Ä–∞–∫–æ–Ω", "—Å—Ç–∞—Ä—ã–π –º–∞–≥", "–∫–∏–±–µ—Ä-—Å–∞–º—É—Ä–∞–π"], details: ["—Å–≤–µ—Ç—è—â–∏–µ—Å—è –≥–ª–∞–∑–∞", "–≤ —Ä—É–∫–∞—Ö –ø–æ—Å–æ—Ö", "–Ω–µ–∂–Ω—ã–π –≤–∑–≥–ª—è–¥", "–∫–∞–ø–ª–∏ –¥–æ–∂–¥—è", "–±–æ–µ–≤–∞—è –ø–æ–∑–∞", "–≤ –æ–∫—Ä—É–∂–µ–Ω–∏–∏ –±–∞–±–æ—á–µ–∫", "—Å –∏–º–ø–ª–∞–Ω—Ç–∞–º–∏"], style: ["–≤ —Å—Ç–∏–ª–µ –∞–Ω–∏–º–µ 90-—Ö", "–≤ —Å—Ç–∏–ª–µ –∫–∏–±–µ—Ä–ø–∞–Ω–∫", "—ç–ø–∏—á–Ω–æ–µ —Ñ—ç–Ω—Ç–µ–∑–∏", "–º—Ä–∞—á–Ω–∞—è –∞—Ç–º–æ—Å—Ñ–µ—Ä–∞", "—è—Ä–∫–∏–µ —Ü–≤–µ—Ç–∞", "–ø–∞—Å—Ç–µ–ª—å–Ω—ã–µ —Ç–æ–Ω–∞"], artist: ["–æ—Ç Artgerm", "–æ—Ç Greg Rutkowski", "–æ—Ç Makoto Shinkai", "–≤ —Å—Ç–∏–ª–µ Ghibli", "–≤ —Å—Ç–∏–ª–µ Riot Games"] }; const getRandomElement = (arr) => arr[Math.floor(Math.random() * arr.length)]; elements.promptInput.value = `${getRandomElement(promptParts.subject)}, ${getRandomElement(promptParts.details)}, ${getRandomElement(promptParts.style)}, ${getRandomElement(promptParts.artist)}`; };
    const applyBackground = async (imageBlob) => { try { await dbRequest(STORE_SETTINGS, 'put', imageBlob, 'customBackground'); const objectURL = URL.createObjectURL(imageBlob); document.body.style.setProperty('--bg-image-url', `url(${objectURL})`); document.body.classList.add('has-custom-bg'); } catch(e) { console.error(e); showError("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–æ–Ω: " + e.message); }};
    const resetBackground = async () => { try { await dbRequest(STORE_SETTINGS, 'delete', 'customBackground'); document.body.style.removeProperty('--bg-image-url'); document.body.classList.remove('has-custom-bg'); } catch(e) { console.error(e); showError("–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Ñ–æ–Ω: " + e.message); }};
    const setBackgroundFromDefault = async (bgId) => { try { const bg = await dbRequest(STORE_BACKGROUNDS, 'get', bgId); if (bg) await applyBackground(bg.blob); } catch(e) { console.error(e); } };
    const handleBackgroundUpload = (e) => { const f = e.target.files[0]; if (!f || !f.type.startsWith('image/')) return; applyBackground(f); e.target.value = ''; };
    const setBackgroundFromGallery = async () => { const c = document.querySelectorAll('.gallery-item .select-checkbox:checked'); if (c.length !== 1) { alert("–í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–≤–Ω–æ –æ–¥–Ω–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ."); return; } try { const item = await dbRequest(STORE_GALLERY, 'get', parseInt(c[0].closest('.gallery-item').dataset.id)); if (!item || !item.data) return; const response = await fetch(item.data); if (!response.ok) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å –≤ Blob'); const blob = await response.blob(); await applyBackground(blob); alert('–§–æ–Ω —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!');} catch(e) { console.error(e); showError(`–ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ñ–æ–Ω: ${e.message}`); }};
    const handleFeedbackSubmit = async (type) => { const textArea = elements[`${type}Text`]; const button = elements[`submit${type}Btn`]; const statusEl = elements[`${type}Status`]; if(!button || !statusEl || !textArea) return console.error('–ù–µ –Ω–∞–π–¥–µ–Ω—ã —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è —Ñ–æ—Ä–º—ã', type); try { const message = textArea.value.trim(); if (!message) { statusEl.textContent = '–ü–æ–ª–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º.'; statusEl.className = 'error'; statusEl.classList.remove('hidden'); return; } button.disabled = true; statusEl.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞...'; statusEl.className = 'success'; statusEl.classList.remove('hidden'); const response = await fetch(`/feedback`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ type, message }) }); if (!response.ok) { const result = await response.json(); throw new Error(result.error || '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞'); } statusEl.textContent = '–°–ø–∞—Å–∏–±–æ! –°–æ–æ–±—â–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ.'; statusEl.className = 'success'; textArea.value = ''; } catch (error) { statusEl.textContent = `–û—à–∏–±–∫–∞: ${error.message}`; statusEl.className = 'error'; } finally { if (button) button.disabled = false; setTimeout(() => statusEl.classList.add('hidden'), 4000); } };
    // *** –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï #4: –ò–∑–º–µ–Ω—è–µ–º –∫–ª—é—á, —á—Ç–æ–±—ã —Ñ–æ–Ω—ã –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏–ª–∏—Å—å ***
    const setupDefaultBackgrounds = async () => { try { const installed = await dbRequest(STORE_SETTINGS, 'get', 'backgrounds_installed_v_final_reset_4'); if (installed) return; elements.loader.classList.remove('hidden'); elements.loaderText.textContent = '–ü–µ—Ä–≤–∏—á–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ–Ω–æ–≤...'; await dbRequest(STORE_BACKGROUNDS, 'clear'); for (const source of defaultBackgroundSources) { try { const response = await fetch(source.url); if (!response.ok) throw new Error(`HTTP error! status: ${response.status} for ${source.name}`); const blob = await response.blob(); await dbRequest(STORE_BACKGROUNDS, 'put', { id: source.name, blob: blob }); console.log(`–§–æ–Ω "${source.name}" —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω.`); } catch (e) { console.error(`–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ–Ω "${source.name}":`, e); } } await dbRequest(STORE_SETTINGS, 'put', true, 'backgrounds_installed_v_final_reset_4'); } catch(e) { console.error("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ —Ñ–æ–Ω–æ–≤:", e); showError("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Ñ–æ–Ω—ã. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å."); } finally { elements.loader.classList.add('hidden'); } };
    const selectAllItems = (select = true) => { document.querySelectorAll('.gallery-item .select-checkbox').forEach(cb => cb.checked = select); };
    const init = async () => { await openDb(); await setupDefaultBackgrounds(); await renderBackgrounds(); state.currentSort = localStorage.getItem('gallerySort') || 'date_desc'; state.isFavFilterActive = localStorage.getItem('isFavFilterActive') === 'true'; state.currentCategory = localStorage.getItem('currentCategory') || 'waifu'; state.currentLanguage = localStorage.getItem('language') || 'ru'; applyTheme(localStorage.getItem('theme') || 'dark'); setLanguage(state.currentLanguage); renderGallery(); try { const savedBgBlob = await dbRequest(STORE_SETTINGS, 'get', 'customBackground'); if (savedBgBlob) { const objectURL = URL.createObjectURL(savedBgBlob); document.body.style.setProperty('--bg-image-url', `url(${objectURL})`); document.body.classList.add('has-custom-bg'); } } catch (e) { console.error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Å—Ç–æ–º–Ω—ã–π —Ñ–æ–Ω –∏–∑ IndexedDB:", e); } };
    const closeAllPanels = () => document.querySelectorAll('.panel-overlay').forEach(p => closePanel(p));
    document.body.addEventListener('click', (e) => { if (elements.menuBtn && !elements.menuBtn.contains(e.target) && elements.dropdownMenu && !elements.dropdownMenu.contains(e.target)) { elements.dropdownMenu.style.display = 'none'; } if (elements.contextMenu && !elements.contextMenu.contains(e.target) && !e.target.classList.contains('item-menu-btn')) { hideContextMenu(); } });
    elements.menuBtn.addEventListener('click', (e) => { e.stopPropagation(); elements.dropdownMenu.style.display = (elements.dropdownMenu.style.display === 'block') ? 'none' : 'block'; });
    document.querySelectorAll('.panel-overlay').forEach(panel => {
        panel.addEventListener('click', (e) => {
            if (e.target.classList.contains('panel-close-btn')) { closePanel(panel); } 
            else if (e.target.classList.contains('panel-back-btn')) { closePanel(panel); openPanel(elements.settingsPanel); }
            else if (e.target === panel) { closePanel(panel); }
        });
    });
    const setupPanelButton = (btn, panel, shouldCloseDropdown = false) => { if(btn) btn.addEventListener('click', () => { closeAllPanels(); openPanel(panel); if(shouldCloseDropdown && elements.dropdownMenu) elements.dropdownMenu.style.display = 'none'; }); }
    setupPanelButton(elements.settingsOpenBtn, elements.settingsPanel, true); setupPanelButton(elements.themePanelOpenBtn, elements.themePanel); setupPanelButton(elements.backgroundPanelOpenBtn, elements.backgroundPanel); setupPanelButton(elements.sortPanelOpenBtn, elements.sortPanel); setupPanelButton(elements.changelogOpenBtn, elements.changelogPanel); setupPanelButton(elements.bugReportOpenBtn, elements.bugReportPanel); setupPanelButton(elements.suggestionOpenBtn, elements.suggestionPanel);
    elements.generateBtn.addEventListener('click', handleAiGeneration); elements.randomPromptBtn.addEventListener('click', generateRandomPrompt);
    elements.findSimilarBtn.addEventListener('click', findSimilarOnline);
    elements.randomImageBtn.addEventListener('click', getRandomImage);
    elements.saveBtn.addEventListener('click', saveResultToGallery);
    elements.previewBtn.addEventListener('click', () => { const img = elements.imageContainer.querySelector('img'); if (img) viewImage(img.src); });
    elements.uploadBtn.addEventListener('click', () => elements.uploadInput.click());
    elements.uploadInput.addEventListener('change', handleUpload);
    elements.exportBtn.addEventListener('click', exportSelected);
    elements.deleteBtn.addEventListener('click', deleteSelected);
    elements.themeResetBtn.addEventListener('click', () => applyTheme('dark'));
    elements.backgroundResetBtn.addEventListener('click', resetBackground);
    elements.backgroundUploadBtn.addEventListener('click', () => elements.backgroundUploadInput.click());
    elements.backgroundUploadInput.addEventListener('change', handleBackgroundUpload);
    elements.clearGalleryBtn.addEventListener('click', clearGallery);
    elements.setBgFromGalleryBtn.addEventListener('click', setBackgroundFromGallery);
    elements.langSwitcherBtn.addEventListener('click', () => { const nextLang = state.currentLanguage === 'ru' ? 'en' : 'ru'; setLanguage(nextLang); });
    elements.submitBugReportBtn.addEventListener('click', () => handleFeedbackSubmit('bug'));
    elements.submitSuggestionBtn.addEventListener('click', () => handleFeedbackSubmit('suggestion'));
    elements.selectAllBtn.addEventListener('click', () => selectAllItems(true));
    elements.deselectAllBtn.addEventListener('click', () => selectAllItems(false));
    elements.sortGrid.addEventListener('click', async (e) => { const sortEl = e.target.closest('[data-sort]'); if (!sortEl) return; const sortType = sortEl.dataset.sort; if (sortType === 'filter_favorite') { state.isFavFilterActive = !state.isFavFilterActive; localStorage.setItem('isFavFilterActive', state.isFavFilterActive); renderGallery(); renderSortOptions(); } else { state.currentSort = sortType; localStorage.setItem('gallerySort', state.currentSort); renderGallery(); closePanel(elements.sortPanel); }});
    elements.themeGrid.addEventListener('click', (e) => { const themeEl = e.target.closest('[data-theme]'); if (themeEl) { applyTheme(themeEl.dataset.theme); }});
    elements.backgroundGrid.addEventListener('click', (e) => { const bgCard = e.target.closest('[data-bg-id]'); if (bgCard) { setBackgroundFromDefault(bgCard.dataset.bgId); } });
    elements.contextMenu.addEventListener('click', async (e) => { e.stopPropagation(); const action = e.target.dataset.action; if (!action || !state.contextedItemId) return; const item = await dbRequest(STORE_GALLERY, 'get', state.contextedItemId); if (!item) return; if (action === 'rename') { const newPrompt = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ø—Ä–æ–º–ø—Ç:", item.prompt); if (newPrompt !== null && newPrompt.trim() !== "") { item.prompt = newPrompt; await dbRequest(STORE_GALLERY, 'put', item); await renderGallery(); } } if (action === 'copy-prompt') { if (item.prompt) { navigator.clipboard.writeText(item.prompt).then(() => alert('–ü—Ä–æ–º–ø—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!')).catch(err => console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:', err)); } } hideContextMenu(); });

    init();
});

// --- –ö–û–ù–ï–¶ –§–ê–ô–õ–ê client.js ---