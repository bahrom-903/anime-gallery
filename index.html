<!-- –ù–ê–ß–ê–õ–û –§–ê–ô–õ–ê index.html (–§–ò–ù–ê–õ–¨–ù–´–ô –†–ï–ú–û–ù–¢ - –í–°–ï –í –û–î–ù–û–ú) -->
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8"/><title>üé® Anime Gallery üß† AI-–≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä (v.13 WORKING)</title>
    <meta content="width=device-width, initial-scale=1" name="viewport"/>
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@400;700;900&display=swap" rel="stylesheet"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root { --bg-color: #1f2937; --bg-color-rgb: 31,41,55; --text-color: #f9fafb; --panel-bg: #111827; --panel-bg-rgb: 17,24,39; --button-bg: #10b981; --button-text: #ffffff; --input-bg: #374151; --input-border: #4b5563; --error-color: #ef4444; }
        body.theme-light { --bg-color: #f9fafb; --bg-color-rgb: 249,250,251; --text-color: #111827; --panel-bg: #ffffff; --panel-bg-rgb: 255,255,255; --button-bg: #3b82f6; --button-text: #ffffff; --input-bg: #e5e7eb; --input-border: #d1d5db; }
        body { background-color: var(--bg-color); color: var(--text-color); font-family: 'Exo 2', sans-serif; margin:0; padding:0; transition: background-color 0.3s, color 0.3s; min-height: 100vh; }
        .container { max-width:1200px; margin:auto; padding:20px; box-sizing: border-box; }
        .generator-area, .gallery-wrapper { background: var(--panel-bg); padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        body.has-custom-bg { background-image: var(--bg-image-url); background-size: cover; background-position: center center; background-attachment: fixed; }
        body.has-custom-bg .generator-area, body.has-custom-bg .gallery-wrapper { background-color: rgba(var(--panel-bg-rgb), 0.6); backdrop-filter: blur(14px); -webkit-backdrop-filter: blur(14px); border: 1px solid rgba(255, 255, 255, 0.1); }
        h1, h2 { text-align: center; }
        button { background: var(--button-bg); color: var(--button-text); border: none; padding: 10px 20px; font-size: 1em; border-radius: 5px; cursor: pointer; margin: 5px; transition: background-color 0.2s, transform 0.1s; }
        button:hover { filter: brightness(1.1); } button:active { transform: scale(0.98); }
        button:disabled { background-color: #9ca3af; color: #e5e7eb; cursor: not-allowed; transform: none; }
        textarea, select, input[type="number"] { width: 100%; padding: 10px; border: 1px solid var(--input-border); border-radius: 8px; font-size: 16px; box-sizing: border-box; background: var(--input-bg); color: var(--text-color); margin-bottom: 10px; }
        .generator-controls, .gallery-controls { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-bottom: 15px;}
        #category-controls button.active-category { background: var(--button-bg); color: var(--button-text); box-shadow: 0 0 10px -2px var(--button-bg); }
        .result-area { margin-top: 20px; min-height: 256px; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        #result-image-container { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }
        #result-image-container img { display: block; max-width: 100%; height: auto; max-height: 300px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .error, .success { font-weight: bold; padding: 5px 10px; border-radius: 5px; } .error { color: var(--error-color); } .success { color: #22c55e; }
        .hidden { display: none; }
        #loader { display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .spinner { border: 8px solid #f3f3f340; border-top: 8px solid var(--button-bg); border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .ai-settings-panel { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; padding: 15px; background-color: rgba(var(--bg-color-rgb), 0.3); border-radius: 8px; margin-bottom: 20px; border: 1px solid var(--input-border); }
        .setting-group { display: flex; flex-direction: column; gap: 5px; }
        .setting-group label { font-size: 14px; font-weight: bold; opacity: 0.8; }
        .setting-group .dimensions { display: flex; align-items: center; gap: 5px; }
        .setting-group .dimensions input { width: 70px; margin-bottom: 0; }
        .selection-controls { display: flex; justify-content: center; gap: 15px; margin-bottom: 15px; }
        .checkbox-btn { all: unset; box-sizing: border-box; display: inline-flex; align-items: center; gap: 8px; cursor: pointer; padding: 8px 12px; border-radius: 5px; transition: background-color 0.2s, color 0.2s; background-color: var(--input-bg); border: 1px solid var(--input-border); font-size: 14px; color: var(--text-color); }
        .checkbox-btn::before { content: 'üî≤'; font-size: 1.2em; transition: transform 0.2s; }
        .checkbox-btn:hover { background-color: var(--button-bg); color: var(--button-text); }
        .checkbox-btn#select-all-btn::before { content: '‚úÖ';}
        #menuToggle { position:fixed; top:10px; right:15px; z-index:1000; }
        #dropdownMenu { display:none; position:absolute; right:0; top:45px; background:var(--panel-bg); color:var(--text-color); border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.3); padding:10px; min-width:200px; }
        .panel-overlay { display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:#000000bb; z-index:1001; justify-content:center; align-items:center; }
        .panel-content { background: var(--panel-bg); width: 90%; max-width: 500px; padding:20px; border-radius:12px; color:var(--text-color); box-sizing:border-box; overflow-y: auto; max-height: 90vh;}
        .panel-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; }
        .gallery { column-count: 5; column-gap: 15px; margin-top: 20px; }
        @media (max-width: 1200px) { .gallery { column-count: 4; } } @media (max-width: 900px) { .gallery { column-count: 3; } } @media (max-width: 600px) { .gallery { column-count: 2; } }
        .gallery-item { display: inline-block; position:relative; margin-bottom: 15px; break-inside: avoid; background: var(--panel-bg); border-radius: 8px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .gallery-item img { display: block; width: 100%; height: auto; }
        .item-controls { position: absolute; top: 8px; left: 8px; display: flex; flex-direction: column; gap: 8px; background-color: rgba(var(--panel-bg-rgb), 0.5); padding: 4px; border-radius: 5px; opacity: 0; transition: opacity 0.2s; }
        .gallery-item:hover .item-controls { opacity: 1; }
    </style>
</head>
<body>
<div class="container">
    <div id="menuToggle"><button id="menu-btn">‚â°</button><div id="dropdownMenu"><button id="settings-open-btn">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</button></div></div>
    <h1>üé® Anime Gallery üß† AI-–≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä</h1>
    <div class="generator-area">
        <h2>–ù–æ–≤–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è</h2>
        <textarea id="prompt-input" placeholder="–û–ø–∏—à–∏ —Å–≤–æ—é –∏–¥–µ—é..."></textarea>
        <textarea id="negative-prompt-input" placeholder="–ß—Ç–æ –ù–ï –Ω—É–∂–Ω–æ —Ä–∏—Å–æ–≤–∞—Ç—å..."></textarea>
        <div class="ai-settings-panel">
            <div class="setting-group"><label for="model-selector">AI –ú–æ–¥–µ–ª—å</label><select id="model-selector"></select></div>
            <div class="setting-group"><label for="image-count">–ö–æ–ª-–≤–æ</label><input type="number" id="image-count" min="1" max="4" value="1"></div>
            <div class="setting-group"><label>–†–∞–∑–º–µ—Ä</label><div class="dimensions">W: <input type="number" id="image-width" value="768" step="64" min="128" max="2048"> H: <input type="number" id="image-height" value="1024" step="64" min="128" max="2048"></div></div>
        </div>
        <div class="generator-controls"><button id="generate-btn">‚ú® –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å AI</button><button id="random-prompt-btn" title="–°–ª—É—á–∞–π–Ω—ã–π –ø—Ä–æ–º–ø—Ç">üé≤</button><button id="find-similar-btn">üåé –ù–∞–π—Ç–∏ –≤ —Å–µ—Ç–∏</button><button id="random-image-btn">üé≤ –°–ª—É—á–∞–π–Ω–æ–µ</button></div>
        <div class="result-area"><div id="loader" class="hidden"><div class="spinner"></div><span id="loader-text"></span></div><div id="result-image-container"></div><p id="error-message" class="error hidden"></p></div>
        <div class="generator-controls"><button id="save-btn" class="hidden">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button><button id="preview-btn" class="hidden">üîç –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</button></div>
    </div>
    <div class="gallery-wrapper">
        <h2>üìÅ –ì–∞–ª–µ—Ä–µ—è</h2>
        <div id="category-controls" class="gallery-controls"></div>
        <div class="selection-controls"><button id="select-all-btn" class="checkbox-btn">–í—ã–±—Ä–∞—Ç—å –≤—Å—ë</button><button id="deselect-all-btn" class="checkbox-btn">–û—Ç–º–µ–Ω–∏—Ç—å –≤—Å—ë</button></div>
        <div class="gallery-controls"><button id="upload-btn">üì• –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–≤–æ—ë</button><input id="upload-input" type="file" accept="image/*" class="hidden"/><button id="export-selected-btn">üì§ –≠–∫—Å–ø–æ—Ä—Ç</button><button id="set-bg-from-gallery-btn">üèûÔ∏è –°–¥–µ–ª–∞—Ç—å —Ñ–æ–Ω–æ–º</button><button id="delete-selected-btn">üóë –£–¥–∞–ª–∏—Ç—å</button></div>
        <div class="gallery" id="gallery"></div>
    </div>
</div>
<!-- –ü–∞–Ω–µ–ª–∏ -->
<div id="settingsPanel" class="panel-overlay"><div class="panel-content"><div class="panel-header"><h2>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2><button class="panel-close-btn">‚úñ</button></div><div class="panel-items"><button class="panel-button" id="theme-panel-open-btn">üé® –¢–µ–º—ã</button><button class="panel-button" id="background-panel-open-btn">üñºÔ∏è –§–æ–Ω</button><button class="panel-button" id="bug-report-open-btn">üêû –°–æ–æ–±—â–∏—Ç—å –æ –ø—Ä–æ–±–ª–µ–º–µ</button><button class="panel-button" id="suggestion-open-btn">üí° –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –∏–¥–µ—é</button><hr><button class="panel-button" id="gallery-clear-btn" style="color: var(--error-color);">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –≥–∞–ª–µ—Ä–µ—é</button></div></div></div>
<div id="bugReportPanel" class="panel-overlay"><div class="panel-content"><div class="panel-header"><button class="panel-back-btn">‚¨ÖÔ∏è</button><h2>üêû –°–æ–æ–±—â–∏—Ç—å –æ –ø—Ä–æ–±–ª–µ–º–µ</h2><button class="panel-close-btn">‚úñ</button></div><p>–û–ø–∏—à–∏—Ç–µ –ø—Ä–æ–±–ª–µ–º—É –∫–∞–∫ –º–æ–∂–Ω–æ –ø–æ–¥—Ä–æ–±–Ω–µ–µ.</p><textarea class="feedback-textarea" id="bug-report-text"></textarea><button id="submit-bug-report-btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button><p id="bug-report-status" class="hidden"></p></div></div>
<div id="suggestionPanel" class="panel-overlay"><div class="panel-content"><div class="panel-header"><button class="panel-back-btn">‚¨ÖÔ∏è</button><h2>üí° –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –∏–¥–µ—é</h2><button class="panel-close-btn">‚úñ</button></div><p>–ï—Å—Ç—å –∏–¥–µ—è, –∫–∞–∫ —Å–¥–µ–ª–∞—Ç—å —Å–µ—Ä–≤–∏—Å –ª—É—á—à–µ?</p><textarea class="feedback-textarea" id="suggestion-text"></textarea><button id="submit-suggestion-btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button><p id="suggestion-status" class="hidden"></p></div></div>
<div id="themePanel" class="panel-overlay"><div class="panel-content"><div class="panel-header"><button class="panel-back-btn">‚¨ÖÔ∏è</button><h2>üé® –¢–µ–º—ã</h2><button class="panel-close-btn" id="theme-reset-btn">üîÑ</button></div><div id="themeGrid"></div></div></div>
<div id="backgroundPanel" class="panel-overlay"><div class="panel-content"><div class="panel-header"><button class="panel-back-btn">‚¨ÖÔ∏è</button><h2>üñºÔ∏è –§–æ–Ω—ã</h2><button class="panel-close-btn" id="background-reset-btn">üîÑ</button></div><div class="panel-items"><button class="panel-button" id="background-upload-btn">üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–≤–æ–π —Ñ–æ–Ω</button><input id="background-upload-input" type="file" accept="image/*" class="hidden"/></div><hr><div id="backgroundGrid"></div></div></div>
<div id="image-viewer" class="panel-overlay"><div class="panel-content"><img id="viewer-img"></div></div>

<script>
// --- –ù–ê–ß–ê–õ–û JAVASCRIPT ---
document.addEventListener('DOMContentLoaded', async () => {
    // --- –°–ü–ò–°–û–ö AI-–ú–û–î–ï–õ–ï–ô ---
    const AI_MODELS = [
        { name: "–ê–Ω–∏–º–µ (–Ø—Ä–∫–∏–π —Å—Ç–∏–ª—å)", id: "p1xts/anime-pastel-dream:66b263166158739343ba8295b281f654b4243b7431215b4971a8143a579d479c" },
        { name: "–ê–Ω–∏–º–µ (–†–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π)", id: "cagliostrolab/animagine-xl-3.1:549a1a72c3a514de13e512495dcf74a3878d4948b3b7437876a44300305e7143" },
        { name: "–§–æ—Ç–æ—Ä–µ–∞–ª–∏–∑–º (–û–±—â–∏–π)", id: "lucataco/absolute-reality:6d35593855518591fece36e2f694e2e6048a1a33748283a0026a09051375d15f" },
        { name: "–§—ç–Ω—Ç–µ–∑–∏ (–î–µ—Ç–∞–ª—å–Ω—ã–π)", id: "p1xts/dreamshaper-v8:3c5291f9b8577262051684c9f7375279b324003013eb194dd446f28b293cc54f" },
        { name: "SD 2.1 (–ë—ã—Å—Ç—Ä—ã–π)", id: "stability-ai/stable-diffusion-2-1:db21e45d3f7023abc2a46ee38a23973f6dce16bb082a930b0c49861f96d1e5bf" },
    ];
    // --- –°–°–´–õ–ö–ò –ù–ê –§–û–ù–´ (—Å –≤–Ω–µ—à–Ω–µ–≥–æ —Ö–æ—Å—Ç–∏–Ω–≥–∞) ---
    const defaultBackgroundSources = [
        { name: 'cyberpunk', url: 'https://i.ibb.co/VtBwQGf/cyberpunk.jpg'}, { name: 'night-tokyo', url: 'https://i.ibb.co/Tmg7VqS/night-tokyo.jpg'},
        { name: 'canyon', url: 'https://i.ibb.co/3fd2z8c/canyon.jpg'}, { name: 'mountain-river', url: 'https://i.ibb.co/9vY7NTS/mountain-river.jpg'},
        { name: 'dark-fantasy', url: 'https://i.ibb.co/fCvxDT1/dark-fantasy.jpg'}, { name: 'noir-landscape', url: 'https://i.ibb.co/9V9bM7v/noir-landscape.jpg'},
        { name: 'auto-night', url: 'https://i.ibb.co/K2fM79m/auto-night.jpg'}, { name: 'anime-city', url: 'https://i.ibb.co/4Kj39qP/anime-city.jpg'},
        { name: 'nier-2b', url: 'https://i.ibb.co/Gxhg6p2/nier-2b.jpg'}, { name: 'genos', url: 'https://i.ibb.co/T1H8Q5z/genos.jpg'}
    ];
    
    const elementIds = ['generateBtn', 'findSimilarBtn', 'randomImageBtn', 'promptInput', 'loader', 'loaderText', 'imageContainer', 'errorMessage', 'saveBtn', 'previewBtn', 'galleryContainer', 'uploadBtn', 'uploadInput', 'exportBtn', 'deleteBtn', 'menuBtn', 'dropdownMenu', 'settingsPanel', 'settingsOpenBtn', 'themePanel', 'themePanelOpenBtn', 'themeResetBtn', 'backgroundPanel', 'backgroundPanelOpenBtn', 'backgroundResetBtn', 'backgroundGrid', 'backgroundUploadBtn', 'backgroundUploadInput', 'randomPromptBtn', 'negativePromptInput', 'modelSelector', 'imageCount', 'imageWidth', 'imageHeight', 'bugReportPanel', 'suggestionPanel', 'bugReportText', 'suggestionText', 'submitBugReportBtn', 'submitSuggestionBtn', 'bugReportStatus', 'suggestionStatus', 'categoryControls', 'selectAllBtn', 'deselectAllBtn'];
    const elements = {};
    elementIds.forEach(id => elements[id] = document.getElementById(id));

    const DB_NAME = 'AnimeGalleryDB_V22_FINAL', DB_VERSION = 1, STORE_SETTINGS = 'settings', STORE_GALLERY = 'gallery', STORE_BACKGROUNDS = 'defaultBackgrounds';
    let state = { currentCategory: 'waifu' };
    const categories = { 'waifu': { sources: { random: 'https://api.waifu.pics/sfw/waifu' } }, 'anime_gif': { sources: { random: 'https://api.waifu.pics/sfw/dance' } }, 'cyberpunk': { sources: { random: 'https://source.unsplash.com/1600x900/?cyberpunk,neon,rain' } }, 'nature': { sources: { random: 'https://source.unsplash.com/1600x900/?nature,landscape' } }, 'games': { sources: { random: 'https://source.unsplash.com/1600x900/?gaming,character,art' } }, 'dark_anime': { sources: { random: 'https://source.unsplash.com/1600x900/?dark,fantasy,anime,art' } }, 'supercars': { sources: { random: 'https://source.unsplash.com/1600x900/?supercar,JDM' } }, };
    
    const openDb = () => new Promise((res, rej) => { const r = indexedDB.open(DB_NAME, DB_VERSION); r.onerror = () => rej("DB Error"); r.onupgradeneeded = e => { const db = e.target.result; ['settings', 'gallery', 'defaultBackgrounds'].forEach(s => { if (!db.objectStoreNames.contains(s)) db.createObjectStore(s, s === 'gallery' ? { keyPath: 'id' } : undefined); }); }; r.onsuccess = e => res(e.target.result); });
    const dbRequest = (store, type, ...args) => new Promise(async (res, rej) => { try { const db = await openDb(); const req = db.transaction(store, type.startsWith('get') ? 'readonly' : 'readwrite').objectStore(store)[type](...args); req.onsuccess = () => res(req.result); req.onerror = () => rej(req.error); } catch (e) { rej(e); } });

    const setUIGeneratorState = (isLoading, message = '') => {
        [elements.generateBtn, elements.findSimilarBtn, elements.randomImageBtn, elements.randomPromptBtn].forEach(btn => btn && (btn.disabled = isLoading));
        elements.loader.classList.toggle('hidden', !isLoading);
        elements.imageContainer.style.display = isLoading ? 'none' : 'flex';
        if (isLoading) { elements.loaderText.textContent = message; elements.errorMessage.classList.add('hidden'); elements.saveBtn.classList.add('hidden'); elements.previewBtn.classList.add('hidden'); }
    };
    const showError = (message) => { elements.errorMessage.textContent = `–û—à–∏–±–∫–∞: ${message}`; elements.errorMessage.classList.remove('hidden'); };
    const displayGeneratedImages = (urls, prompt) => {
        elements.imageContainer.innerHTML = '';
        urls.forEach(url => { const img = document.createElement('img'); img.src = url; img.alt = prompt; img.crossOrigin = "Anonymous"; elements.imageContainer.appendChild(img); });
        elements.saveBtn.classList.toggle('hidden', urls.length === 0);
        elements.previewBtn.classList.toggle('hidden', urls.length === 0);
    };

    const handleServerRequest = async (endpoint, body, loadingMessage) => {
        setUIGeneratorState(true, loadingMessage);
        try {
            const response = await fetch(endpoint, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
            const result = await response.json();
            if (!response.ok) throw new Error(result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
            setUIGeneratorState(false);
            return result;
        } catch (e) { showError(e.message); setUIGeneratorState(false); throw e; }
    };

    const handleAiGeneration = async () => {
        const prompt = elements.promptInput.value.trim();
        if (!prompt) return showError('–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ.');
        try {
            const result = await handleServerRequest('/generate-image', { prompt, negative_prompt: elements.negativePromptInput.value.trim(), model: elements.modelSelector.value, width: elements.imageWidth.value, height: elements.imageHeight.value, num_outputs: elements.imageCount.value }, 'AI-–≥–µ–Ω–µ—Ä–∞—Ü–∏—è...');
            if (result && result.imageUrls) displayGeneratedImages(result.imageUrls, prompt);
        } catch (e) {}
    };

    const getRandomImage = async () => {
        try {
            const result = await handleServerRequest('/get-image-from-source', { url: categories[state.currentCategory].sources.random }, '–ò—â–µ–º —Å–ª—É—á–∞–π–Ω–æ–µ...');
            if (result && result.imageUrl) displayGeneratedImages([result.imageUrl], " ");
        } catch (e) {}
    };

    const handleFeedbackSubmit = async (type) => {
        const textArea = elements[`${type}Text`];
        const statusEl = elements[`${type}Status`];
        const message = textArea.value.trim();
        if (!message) return;
        try {
            const result = await handleServerRequest('/feedback', { type, message }, '–û—Ç–ø—Ä–∞–≤–∫–∞...');
            statusEl.textContent = result.message; statusEl.className = 'success'; textArea.value = '';
        } catch (e) { statusEl.textContent = `–û—à–∏–±–∫–∞: ${e.message}`; statusEl.className = 'error'; }
        statusEl.classList.remove('hidden'); setTimeout(() => statusEl.classList.add('hidden'), 4000);
    };

    const setupDefaultBackgrounds = async () => {
        try {
            const installed = await dbRequest(STORE_SETTINGS, 'get', 'backgrounds_installed_v_final_fix_13');
            if (installed) return;
            setUIGeneratorState(true, '–ü–µ—Ä–≤–∏—á–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ–Ω–æ–≤...');
            await dbRequest(STORE_BACKGROUNDS, 'clear');
            const promises = defaultBackgroundSources.map(source => 
                fetch(source.url)
                    .then(res => res.ok ? res.blob() : Promise.reject(new Error(res.statusText)))
                    .then(blob => dbRequest(STORE_BACKGROUNDS, 'put', { id: source.name, blob: blob }))
                    .catch(e => console.error(`–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ–Ω: ${source.name}`, e))
            );
            await Promise.all(promises);
            await dbRequest(STORE_SETTINGS, 'put', true, 'backgrounds_installed_v_final_fix_13');
            alert('–§–æ–Ω—ã —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã! –°—Ç—Ä–∞–Ω–∏—Ü–∞ –±—É–¥–µ—Ç –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω–∞.');
            window.location.reload();
        } catch (e) { showError("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ–Ω—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É."); }
        finally { setUIGeneratorState(false); }
    };
    
    // --- –ü–û–õ–ù–û–°–¢–¨–Æ –†–ê–ë–û–ß–ò–ô –ë–õ–û–ö –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–Ø –ö–ù–û–ü–û–ö ---
    const attachEventListeners = () => {
        AI_MODELS.forEach(model => { const option = document.createElement('option'); option.value = model.id; option.textContent = model.name; elements.modelSelector.appendChild(option); });
        
        Object.keys(categories).forEach(id => { 
            const btn = document.createElement('button'); 
            btn.textContent = id.replace(/_/g, ' '); 
            btn.addEventListener('click', () => { 
                state.currentCategory = id; 
                document.querySelector('#category-controls .active-category')?.classList.remove('active-category'); 
                btn.classList.add('active-category'); 
            }); 
            elements.categoryControls.appendChild(btn); 
        });
        document.querySelector('#category-controls button')?.classList.add('active-category');

        elements.generateBtn.addEventListener('click', handleAiGeneration);
        elements.randomImageBtn.addEventListener('click', getRandomImage);
        elements.findSimilarBtn.addEventListener('click', () => alert('–≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ!'));
        elements.submitBugReportBtn.addEventListener('click', () => handleFeedbackSubmit('bug'));
        elements.submitSuggestionBtn.addEventListener('click', () => handleFeedbackSubmit('suggestion'));
        elements.selectAllBtn.addEventListener('click', () => { document.querySelectorAll('.gallery-item input[type="checkbox"]').forEach(cb => cb.checked = true); });
        elements.deselectAllBtn.addEventListener('click', () => { document.querySelectorAll('.gallery-item input[type="checkbox"]').forEach(cb => cb.checked = false); });
        
        elements.settingsOpenBtn.addEventListener('click', () => { elements.settingsPanel.style.display = 'flex'; });
        elements.bugReportOpenBtn.addEventListener('click', () => { elements.settingsPanel.style.display = 'none'; elements.bugReportPanel.style.display = 'flex'; });
        elements.suggestionOpenBtn.addEventListener('click', () => { elements.settingsPanel.style.display = 'none'; elements.suggestionPanel.style.display = 'flex'; });
        elements.themePanelOpenBtn.addEventListener('click', () => { elements.settingsPanel.style.display = 'none'; elements.themePanel.style.display = 'flex'; });
        elements.backgroundPanelOpenBtn.addEventListener('click', () => { elements.settingsPanel.style.display = 'none'; elements.backgroundPanel.style.display = 'flex'; });

        document.querySelectorAll('.panel-overlay').forEach(panel => {
            panel.addEventListener('click', e => {
                const closeBtn = e.target.closest('.panel-close-btn');
                const backBtn = e.target.closest('.panel-back-btn');
                if (closeBtn || e.target === panel) {
                    panel.style.display = 'none';
                } else if (backBtn) {
                    panel.style.display = 'none';
                    elements.settingsPanel.style.display = 'flex';
                }
            });
        });
    };

    // --- –§–ò–ù–ê–õ–¨–ù–´–ô –ó–ê–ü–£–°–ö –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ---
    try {
        await openDb();
        attachEventListeners(); // –°–ù–ê–ß–ê–õ–ê –ø–æ–¥–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫–∏
        await setupDefaultBackgrounds(); // –ü–û–¢–û–ú –ø—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ–Ω—ã
    } catch(e) {
        showError(e.message);
        attachEventListeners(); // –î–∞–∂–µ –µ—Å–ª–∏ DB —É–ø–∞–ª–∞, –∫–Ω–æ–ø–∫–∏ –¥–æ–ª–∂–Ω—ã —Ä–∞–±–æ—Ç–∞—Ç—å!
    }
});
</script>
</body>
</html>
<!-- –ö–û–ù–ï–¶ –§–ê–ô–õ–ê index.html -->